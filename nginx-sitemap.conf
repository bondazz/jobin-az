# --- jooble.az: Sitemap reverse proxy (Supabase) ---

# XML MIME-i dəqiqləşdir (bir dəfə kifayətdir)
types {
    application/xml  xml;
}

# BÜTÜN /sitemap*.xml yolları üçün ümumi qayda
location ~ ^/sitemap.*\.xml$ {
    # Upstream-a təmiz sorğu
    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Accept            "application/xml";
    proxy_set_header Accept-Encoding   "";   # lazımi deyilsə sıxmanı söndür

    # URL-dən fayl adını çıxart (named capture)
    if ($uri ~* /(?<sitemap_file>[^/]+\.xml)$) { }

    # Supabase Edge Function-a ötür
    proxy_pass https://igrtzfvphltnoiwedbtz.supabase.co/functions/v1/serve-sitemap?file=$sitemap_file;

    # Tam axın, buferləməni söndür
    proxy_buffering off;

    # CAVAB başlıqlarını düz qur (request deyil!)
    proxy_hide_header Content-Type;
    add_header Content-Type "application/xml; charset=utf-8" always;

    # Keşi söndür (istəyinə görə dəyişə bilərsən)
    add_header Cache-Control "no-store, no-cache, must-revalidate" always;

    # (İstəyə görə) loglar
    access_log /var/log/nginx/sitemap_access.log;
    error_log  /var/log/nginx/sitemap_error.log;
}

# Xüsusi /sitemap.xml üçün ayrıca qayda (istəsən saxla)
location = /sitemap.xml {
    proxy_http_version 1.1;
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Accept            "application/xml";
    proxy_set_header Accept-Encoding   "";

    proxy_pass https://igrtzfvphltnoiwedbtz.supabase.co/functions/v1/serve-sitemap?file=sitemap.xml&storage_path=sitemap.xml;

    proxy_buffering off;

    proxy_hide_header Content-Type;
    add_header Content-Type "application/xml; charset=utf-8" always;
    add_header Cache-Control "no-store, no-cache, must-revalidate" always;

    access_log /var/log/nginx/sitemap_access.log;
    error_log  /var/log/nginx/sitemap_error.log;
}
