# Nginx configuration for jooble.az sitemap reverse proxy
# Add this to your server block in nginx.conf

# Reverse proxy for all sitemap XML files
location ~ ^/sitemap.*\.xml$ {
    # Remove Accept-Encoding to prevent compression issues
    proxy_set_header Accept-Encoding "";
    
    # Standard proxy headers
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Extract filename from URL for file parameter
    set $sitemap_file $1;
    if ($uri ~ ^/(.+\.xml)$) {
        set $sitemap_file $1;
    }
    
    # Proxy to Supabase Edge Function
    proxy_pass https://igrtzfvphltnoiwedbtz.supabase.co/functions/v1/serve-sitemap?file=$sitemap_file;
    
    # Disable buffering for immediate response
    proxy_buffering off;
    
    # Set correct Content-Type
    proxy_set_header Content-Type "application/xml; charset=utf-8";
    
    # Prevent caching of dynamic content during development
    add_header Cache-Control "public, max-age=3600";
    
    # Log for debugging
    access_log /var/log/nginx/sitemap_access.log;
    error_log /var/log/nginx/sitemap_error.log;
}

# Alternative configuration if you prefer specific routes:
# location = /sitemap.xml {
#     proxy_set_header Accept-Encoding "";
#     proxy_pass https://igrtzfvphltnoiwedbtz.supabase.co/functions/v1/serve-sitemap?file=sitemap.xml;
# }
# 
# location = /sitemap_index.xml {
#     proxy_set_header Accept-Encoding "";
#     proxy_pass https://igrtzfvphltnoiwedbtz.supabase.co/functions/v1/serve-sitemap?file=sitemap_index.xml;
# }
# 
# location ~ ^/sitemap-jobs-(\d+)\.xml$ {
#     proxy_set_header Accept-Encoding "";
#     proxy_pass https://igrtzfvphltnoiwedbtz.supabase.co/functions/v1/serve-sitemap?file=sitemap-jobs-$1.xml;
# }
# 
# location ~ ^/sitemap-companies-(\d+)\.xml$ {
#     proxy_set_header Accept-Encoding "";
#     proxy_pass https://igrtzfvphltnoiwedbtz.supabase.co/functions/v1/serve-sitemap?file=sitemap-companies-$1.xml;
# }